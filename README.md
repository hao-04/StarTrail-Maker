# StarTrail Maker ⭐ 星轨视频生成器

将普通星空延时摄影视频转化为星轨效果视频的桌面工具。支持轨迹渐暗衰减、亮度阈值过滤、多帧持续性确认，有效去除飞机/卫星等瞬态物体干扰。

![Python](https://img.shields.io/badge/Python-3.10%2B-blue)
![PyQt6](https://img.shields.io/badge/GUI-PyQt6-green)
![OpenCV](https://img.shields.io/badge/CV-OpenCV-orange)
![License](https://img.shields.io/badge/License-MIT-yellow)

## 功能特性

- **星轨叠加**：逐帧提取亮像素并合成为星轨视频，输出 MP4 格式
- **轨迹渐暗衰减**：旧轨迹随时间自然变暗，呈现彗尾拖尾效果（5 档可调）
- **亮度阈值过滤**：仅保留亮度超过阈值的像素，过滤暗背景噪声和地面杂光（6 档可调）
- **瞬态物体过滤**：基于多帧持续性确认机制，自动过滤飞机、卫星等快速移动亮点（5 档可调）
- **实时预览**：处理过程中实时显示当前合成效果
- **分辨率缩放**：支持 25% / 50% / 75% / 100% 四档，降低分辨率可加速处理并减少内存占用
- **随时取消**：支持中途停止并保存已处理部分

## 截图预览

> 运行程序后可在 GUI 界面中实时预览星轨合成效果。

## 算法说明

每帧处理分五步：

1. **亮像素提取** — 计算当前帧每个像素 RGB 通道的最大值，仅保留亮度超过阈值的像素作为候选。
2. **持续性计数更新** — 为每个像素维护一个持续性计数器：候选亮像素计数 +1（防溢出上限为确认帧数 ×3），非亮像素计数快速衰减（每帧 ×0.5）。
3. **轨迹衰减** — 轨迹层每帧乘以衰减系数（如 0.995），旧轨迹逐渐变暗。
4. **多帧确认入轨** — 仅当像素持续性计数达到确认帧数阈值时，才将其加入轨迹层（取较亮值）。星星在同一位置持续多帧可通过确认；飞机/卫星在每个像素位置仅停留 1-2 帧，计数不足，自然被过滤。
5. **合成输出** — 输出帧 = max(当前帧, 轨迹层)，背景保持当前帧的自然效果，星轨从轨迹层叠加。

### 参数说明

| 参数           | 选项                                                          | 说明                                                               |
| -------------- | ------------------------------------------------------------- | ------------------------------------------------------------------ |
| 视频分辨率缩放 | 100%（原画质）/ 75% / 50% / 25%                               | 降低分辨率可减少内存占用并提升处理速度                             |
| 轨迹衰减速度   | 无衰减 / 极慢(0.999) / 慢速(0.997) / 中速(0.995) / 快速(0.99) | 控制旧轨迹变暗的速率；无衰减即经典全量叠加，所有亮像素永久保留     |
| 亮度过滤阈值   | 0 / 15 / 30 / 60 / 100 / 150                                  | 仅亮度超过此值的像素进入轨迹层；推荐夜景使用 30                    |
| 瞬态物体过滤   | 关闭(1帧) / 轻度(2帧) / 标准(3帧) / 强力(5帧) / 极强(8帧)     | 像素需连续多帧出现才被确认为星星；帧数越高过滤越强，但可能过滤暗星 |

## 快速开始

### 环境要求

- Python 3.10+
- Windows / macOS / Linux

### 安装依赖

```bash
pip install -r requirements.txt
```

### 运行

```bash
python startrail_maker.py
```

### 使用步骤

1. 点击 **选择输入视频**，选择一段星空视频（支持 MP4 / AVI / MOV / MKV）
2. 点击 **选择导出路径**，指定输出 MP4 文件位置
3. 根据需要调整 **视频分辨率缩放**、**轨迹衰减速度**、**亮度过滤阈值** 和 **瞬态物体过滤**
4. 点击 **开始处理**，等待完成即可；处理过程中可随时点击 **取消/停止**

## 项目结构

```
├── startrail_maker.py   # 主程序（GUI + 处理逻辑）
├── requirements.txt     # Python 依赖
├── README.md
├── LICENSE
```

## 许可证

[MIT License](LICENSE)
